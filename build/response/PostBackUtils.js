'use strict';

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };
//import GoGating from '../GoGating';


var _fbLocalChatBot = require('fb-local-chat-bot');

var _fbLocalChatBot2 = _interopRequireDefault(_fbLocalChatBot);

var _User = require('../class/User');

var _User2 = _interopRequireDefault(_User);

var _Game = require('../class/Game');

var _Game2 = _interopRequireDefault(_Game);

var _Translator = require('../translations/Translator');

var _config = require('../config');

var _config2 = _interopRequireDefault(_config);

var _EncryptUtils = require('../utils/EncryptUtils');

var _EncryptUtils2 = _interopRequireDefault(_EncryptUtils);

var _querystring = require('querystring');

var _querystring2 = _interopRequireDefault(_querystring);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var PostBackTypes = {
  CREATE_GAME: 'CREATE_GAME',
  JOIN_GAME: 'JOIN_GAME',
  PLAY_WITH_SELF: 'PLAY_WITH_SELF',
  PLAY_WITH_AI: 'PLAY_WITH_AI',
  JOIN_GAME_WITH_CODE: 'JOIN_GAME_WITH_CODE',

  SEE_HELP: 'SEE_HELP',
  SHARE: 'SHARE',
  SHOW_MESSENGER_WEBVIEW_TOKEN: 'SHOW_MESSENGER_WEBVIEW_TOKEN', // deprecated
  SHOW_GAME_HISTORY: 'SHOW_GAME_HISTORY',
  DOWNLOAD_SGF: 'DOWNLOAD_SGF',

  // language settings
  SHOW_LANGUAGES: 'SHOW_LANGUAGES',
  SET_LANGUAGE: 'SET_LANGUAGE',

  // in game commands
  RESIGN_GAME: 'RESIGN_GAME',
  SHOW_CURRENT_GAME_STATUS: 'SHOW_CURRENT_GAME_STATUS',
  PASS_MOVE: 'PASS_MOVE',
  UNDO_MOVE: 'UNDO_MOVE',
  FOCUS_ON_GAME: 'FOCUS_ON_GAME',
  PLAY_ANOTHER_GAME: 'PLAY_ANOTHER_GAME',
  SHOW_ACTIVE_GAMES: 'SHOW_ACTIVE_GAMES',
  SHOW_CANNED_MESSAGES: 'SHOW_CANNED_MESSAGES', // deprecated
  SEND_CANNED_MESSAGE: 'SEND_CANNED_MESSAGE', // deprecated
  SHOW_MESSAGE_VIEW: 'SHOW_MESSAGE_VIEW',

  // game room
  CREATE_PRIVATE_ROOM: 'CREATE_PRIVATE_ROOM',
  SEND_GAME_ROOM_SHARE: 'SEND_GAME_ROOM_SHARE'
};

function createPostbackButton(text, type, params) {
  // append params to post type callback
  var payload = params ? type + ':' + params.join(':') : type;
  return _fbLocalChatBot2.default.createPostbackButton(text, payload);
}

function createQuickReplyButton(text, type, params) {
  // append params to post type callback
  var payload = params ? type + ':' + params.join(':') : type;
  return _fbLocalChatBot2.default.createQuickReply(text, payload);
}

function createDefaultButtons(user) {
  var language = user.getLanguage();
  return [createQuickReplyButton((0, _Translator.got)('button.setLanguage', language), PostBackTypes.SHOW_LANGUAGES), createQuickReplyButton((0, _Translator.got)('button.share', language), PostBackTypes.SHARE)];
}

function sendNormalHelpMenu(user, text) {
  var encryptID = _EncryptUtils2.default.encrypt(user.getFBID());

  // Hopefully we can open webview from quick repies in the future
  var messageData = {
    attachment: {
      'type': 'template',
      'payload': {
        'template_type': 'button',
        'text': text,
        'buttons': [getCreateGameURLButton(user.getLanguage(), encryptID), getJoinGameURLButton(user.getLanguage(), encryptID)]
      }
    },
    quick_replies: createDefaultButtons(user)
  };

  _fbLocalChatBot2.default.send(user.getFBID(), messageData);
}

function _getURLParams(language, encryptID, extra) {
  // skip appending user id if it's not provided
  return encryptID ? _querystring2.default.stringify(_extends({}, extra, { language: language, u: encryptID })) : _querystring2.default.stringify(_extends({}, extra, { language: language }));
}

function getCreateGameURLButton(language, encryptID) {
  var queryParams = _getURLParams(language, encryptID);
  return _fbLocalChatBot2.default.createURLButton((0, _Translator.got)('button.createGame', language), _config2.default.url + '/game/create?' + queryParams, 'tall', true);
}

// useMessengerExtensions
function getJoinGameURLButton(language, encryptID) {
  var queryParams = _getURLParams(language, encryptID);
  return _fbLocalChatBot2.default.createURLButton((0, _Translator.got)('button.joinARoom', language), _config2.default.url + '/joinGame?' + queryParams, 'compact', true);
}

// useMessengerExtensions
function getMessageURLButton(title, language, receiverID, encryptID) {
  var queryParamsString = _getURLParams(language, encryptID, { receiverID: receiverID });
  return _fbLocalChatBot2.default.createURLButton(title, _config2.default.url + '/message?' + queryParamsString, 'full', true);
}

// useMessengerExtensions
function getBoardURLButton(title, queryParams) {
  return _fbLocalChatBot2.default.createURLButton(title, _config2.default.url + '/simulateBoard?' + queryParams, 'full', true);
}

// useMessengerExtensions
function getCountScoreURLButton(title, user, queryParams) {
  var encryptID = _EncryptUtils2.default.encrypt(user.getFBID());
  var queryParamsString = _getURLParams(user.getLanguage(), encryptID, queryParams);
  return _fbLocalChatBot2.default.createURLButton(title, _config2.default.url + '/countScore?' + queryParamsString, 'full', true);
}

// useMessengerExtensions
function getSimulateBoardURLButton(language, encryptID) {
  var queryParams = _getURLParams(language, encryptID);
  return getBoardURLButton((0, _Translator.got)('button.simulateGame', language), queryParams);
}

function sendFocusedGameMessage(user, game, message, isFocused) {
  var language = user.getLanguage();
  if (isFocused) {
    _fbLocalChatBot2.default.sendText(user.getFBID(), message);
  } else {
    _fbLocalChatBot2.default.sendButtons(user.getFBID(), message + ' ' + (0, _Translator.got)('inGameMessage.newGameMoveAskUserToFocus', language), [createPostbackButton((0, _Translator.got)('button.focusOnGame', language), PostBackTypes.FOCUS_ON_GAME, [game.getID()])]);
  }
}

module.exports = {
  PostBackTypes: PostBackTypes,
  sendNormalHelpMenu: sendNormalHelpMenu,
  createDefaultButtons: createDefaultButtons,
  createPostbackButton: createPostbackButton,
  createQuickReplyButton: createQuickReplyButton,
  sendFocusedGameMessage: sendFocusedGameMessage,
  getBoardURLButton: getBoardURLButton,
  getCreateGameURLButton: getCreateGameURLButton,
  getJoinGameURLButton: getJoinGameURLButton,
  getSimulateBoardURLButton: getSimulateBoardURLButton,
  getCountScoreURLButton: getCountScoreURLButton,
  getMessageURLButton: getMessageURLButton
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZXNwb25zZS9Qb3N0QmFja1V0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUVBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUVBOztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsSUFBTSxnQkFBZ0I7QUFDcEIsZUFBYSxhQURPO0FBRXBCLGFBQVcsV0FGUztBQUdwQixrQkFBZ0IsZ0JBSEk7QUFJcEIsZ0JBQWMsY0FKTTtBQUtwQix1QkFBcUIscUJBTEQ7O0FBT3BCLFlBQVUsVUFQVTtBQVFwQixTQUFPLE9BUmE7QUFTcEIsZ0NBQThCLDhCQVRWLEU7QUFVcEIscUJBQW1CLG1CQVZDO0FBV3BCLGdCQUFjLGNBWE07OztBQWNwQixrQkFBZ0IsZ0JBZEk7QUFlcEIsZ0JBQWMsY0FmTTs7O0FBa0JwQixlQUFhLGFBbEJPO0FBbUJwQiw0QkFBMEIsMEJBbkJOO0FBb0JwQixhQUFXLFdBcEJTO0FBcUJwQixhQUFXLFdBckJTO0FBc0JwQixpQkFBZSxlQXRCSztBQXVCcEIscUJBQW1CLG1CQXZCQztBQXdCcEIscUJBQW1CLG1CQXhCQztBQXlCcEIsd0JBQXNCLHNCQXpCRixFO0FBMEJwQix1QkFBcUIscUJBMUJELEU7QUEyQnBCLHFCQUFtQixtQkEzQkM7OztBQThCcEIsdUJBQXFCLHFCQTlCRDtBQStCcEIsd0JBQXNCO0FBL0JGLENBQXRCOztBQWtDQSxTQUFTLG9CQUFULENBQThCLElBQTlCLEVBQTRDLElBQTVDLEVBQTBELE1BQTFELEVBQXlGOztBQUV2RixNQUFNLFVBQVUsU0FDWixPQUFPLEdBQVAsR0FBYSxPQUFPLElBQVAsQ0FBWSxHQUFaLENBREQsR0FFWixJQUZKO0FBR0EsU0FBTyx5QkFBSSxvQkFBSixDQUF5QixJQUF6QixFQUErQixPQUEvQixDQUFQO0FBQ0Q7O0FBRUQsU0FBUyxzQkFBVCxDQUFnQyxJQUFoQyxFQUE4QyxJQUE5QyxFQUE0RCxNQUE1RCxFQUEyRjs7QUFFekYsTUFBTSxVQUFVLFNB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Ii8vIEBmbG93XG5cbmltcG9ydCBCb3QgZnJvbSAnZmItbG9jYWwtY2hhdC1ib3QnO1xuaW1wb3J0IFVzZXIgZnJvbSAnLi4vY2xhc3MvVXNlcic7XG5pbXBvcnQgR29HYW1lIGZyb20gJy4uL2NsYXNzL0dhbWUnO1xuLy9pbXBvcnQgR29HYXRpbmcgZnJvbSAnLi4vR29HYXRpbmcnO1xuaW1wb3J0IHtnb3R9IGZyb20gJy4uL3RyYW5zbGF0aW9ucy9UcmFuc2xhdG9yJztcbmltcG9ydCBjb25maWcgZnJvbSAnLi4vY29uZmlnJztcbmltcG9ydCBFbmNyeXB0VXRpbHMgZnJvbSAnLi4vdXRpbHMvRW5jcnlwdFV0aWxzJztcbmltcG9ydCBxdWVyeXN0cmluZyBmcm9tICdxdWVyeXN0cmluZyc7XG5cbmNvbnN0IFBvc3RCYWNrVHlwZXMgPSB7XG4gIENSRUFURV9HQU1FOiAnQ1JFQVRFX0dBTUUnLFxuICBKT0lOX0dBTUU6ICdKT0lOX0dBTUUnLFxuICBQTEFZX1dJVEhfU0VMRjogJ1BMQVlfV0lUSF9TRUxGJyxcbiAgUExBWV9XSVRIX0FJOiAnUExBWV9XSVRIX0FJJyxcbiAgSk9JTl9HQU1FX1dJVEhfQ09ERTogJ0pPSU5fR0FNRV9XSVRIX0NPREUnLFxuXG4gIFNFRV9IRUxQOiAnU0VFX0hFTFAnLFxuICBTSEFSRTogJ1NIQVJFJyxcbiAgU0hPV19NRVNTRU5HRVJfV0VCVklFV19UT0tFTjogJ1NIT1dfTUVTU0VOR0VSX1dFQlZJRVdfVE9LRU4nLCAvLyBkZXByZWNhdGVkXG4gIFNIT1dfR0FNRV9ISVNUT1JZOiAnU0hPV19HQU1FX0hJU1RPUlknLFxuICBET1dOTE9BRF9TR0Y6ICdET1dOTE9BRF9TR0YnLFxuXG4gIC8vIGxhbmd1YWdlIHNldHRpbmdzXG4gIFNIT1dfTEFOR1VBR0VTOiAnU0hPV19MQU5HVUFHRVMnLFxuICBTRVRfTEFOR1VBR0U6ICdTRVRfTEFOR1VBR0UnLFxuXG4gIC8vIGluIGdhbWUgY29tbWFuZHNcbiAgUkVTSUdOX0dBTUU6ICdSRVNJR05fR0FNRScsXG4gIFNIT1dfQ1VSUkVOVF9HQU1FX1NUQVRVUzogJ1NIT1dfQ1VSUkVOVF9HQU1FX1NUQVRVUycsXG4gIFBBU1NfTU9WRTogJ1BBU1NfTU9WRScsXG4gIFVORE9fTU9WRTogJ1VORE9fTU9WRScsXG4gIEZPQ1VTX09OX0dBTUU6ICdGT0NVU19PTl9HQU1FJyxcbiAgUExBWV9BTk9USEVSX0dBTUU6ICdQTEFZX0FOT1RIRVJfR0FNRScsXG4gIFNIT1dfQUNUSVZFX0dBTUVTOiAnU0hPV19BQ1RJVkVfR0FNRVMnLFxuICBTSE9XX0NBTk5FRF9NRVNTQUdFUzogJ1NIT1dfQ0FOTkVEX01FU1NBR0VTJywgLy8gZGVwcmVjYXRlZFxuICBTRU5EX0NBTk5FRF9NRVNTQUdFOiAnU0VORF9DQU5ORURfTUVTU0FHRScsIC8vIGRlcHJlY2F0ZWRcbiAgU0hPV19NRVNTQUdFX1ZJRVc6ICdTSE9XX01FU1NBR0VfVklFVycsXG5cbiAgLy8gZ2FtZSByb29tXG4gIENSRUFURV9QUklWQVRFX1JPT006ICdDUkVBVEVfUFJJVkFURV9ST09NJyxcbiAgU0VORF9HQU1FX1JPT01fU0hBUkU6ICdTRU5EX0dBTUVfUk9PTV9TSEFSRScsXG59O1xuXG5mdW5jdGlvbiBjcmVhdGVQb3N0YmFja0J1dHRvbih0ZXh0OiBzdHJpbmcsIHR5cGU6IHN0cmluZywgcGFyYW1zOiA/QXJyYXk8bWl4ZWQ+KTogT2JqZWN0IHtcbiAgLy8gYXBwZW5kIHBhcmFtcyB0byBwb3N0IHR5cGUgY2FsbGJhY2tcbiAgY29uc3QgcGF5bG9hZCA9IHBhcmFtc1xuICAgID8gdHlwZSArICc6JyArIHBhcmFtcy5qb2luKCc6JylcbiAgICA6IHR5cGU7XG4gIHJldHVybiBCb3QuY3JlYXRlUG9zdGJhY2tCdXR0b24odGV4dCwgcGF5bG9hZCk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZVF1aWNrUmVwbHlCdXR0b24odGV4dDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIHBhcmFtczogP0FycmF5PG1peGVkPik6IE9iamVjdCB7XG4gIC8vIGFwcGVuZCBwYXJhbXMgdG8gcG9zdCB0eXBlIGNhbGxiYWNrXG4gIGNvbnN0IHBheWxvYWQgPSBwYXJhbXNcbiAgICA/IHR5cGUgKyAnOicgKyBwYXJhbXMuam9pbignOicpXG4gICAgOiB0eXBlO1xuICByZXR1cm4gQm90LmNyZWF0ZVF1aWNrUmVwbHkodGV4dCwgcGF5bG9hZCk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZURlZmF1bHRCdXR0b25zKHVzZXI6IFVzZXIpOiBBcnJheTxPYmplY3Q+IHtcbiAgY29uc3QgbGFuZ3VhZ2UgPSB1c2VyLmdldExhbmd1YWdlKCk7XG4gIHJldHVybiBbXG4gICAgY3JlYXRlUXVpY2tSZXBseUJ1dHRvbihnb3QoJ2J1dHRvbi5zZXRMYW5ndWFnZScsIGxhbmd1YWdlKSwgUG9zdEJhY2tUeXBlcy5TSE9XX0xBTkdVQUdFUyksXG4gICAgY3JlYXRlUXVpY2tSZXBseUJ1dHRvbihnb3QoJ2J1dHRvbi5zaGFyZScsIGxhbmd1YWdlKSwgUG9zdEJhY2tUeXBlcy5TSEFSRSksXG4gIF07XG59XG5cbmZ1bmN0aW9uIHNlbmROb3JtYWxIZWxwTWVudSh1c2VyOiBVc2VyLCB0ZXh0OiBzdHJpbmcpOiB2b2lkIHtcbiAgY29uc3QgZW5jcnlwdElEID0gRW5jcnlwdFV0aWxzLmVuY3J5cHQodXNlci5nZXRGQklEKCkpO1xuXG4gIC8vIEhvcGVmdWxseSB3ZSBjYW4gb3BlbiB3ZWJ2aWV3IGZyb20gcXVpY2sgcmVwaWVzIGluIHRoZSBmdXR1cmVcbiAgY29uc3QgbWVzc2FnZURhdGEgPSB7XG4gICAgYXR0YWNobWVudDoge1xuICAgICAgJ3R5cGUnOid0ZW1wbGF0ZScsXG4gICAgICAncGF5bG9hZCc6IHtcbiAgICAgICAgJ3RlbXBsYXRlX3R5cGUnOiAnYnV0dG9uJyxcbiAgICAgICAgJ3RleHQnOiB0ZXh0LFxuICAgICAgICAnYnV0dG9ucyc6IFtcbiAgICAgICAgICBnZXRDcmVhdGVHYW1lVVJMQnV0dG9uKHVzZXIuZ2V0TGFuZ3VhZ2UoKSwgZW5jcnlwdElEKSxcbiAgICAgICAgICBnZXRKb2luR2FtZVVSTEJ1dHRvbih1c2VyLmdldExhbmd1YWdlKCksIGVuY3J5cHRJRCksXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgIH0sXG4gICAgcXVpY2tfcmVwbGllczogY3JlYXRlRGVmYXVsdEJ1dHRvbnModXNlciksXG4gIH07XG5cbiAgQm90LnNlbmQodXNlci5nZXRGQklEKCksIG1lc3NhZ2VEYXRhKTtcbn1cblxuZnVuY3Rpb24gX2dldFVSTFBhcmFtcyhsYW5ndWFnZTogc3RyaW5nLCBlbmNyeXB0SUQ/OiBzdHJpbmcsIGV4dHJhPzogT2JqZWN0KTogc3RyaW5nIHtcbiAgLy8gc2tpcCBhcHBlbmRpbmcgdXNlciBpZCBpZiBpdCdzIG5vdCBwcm92aWRlZFxuICByZXR1cm4gZW5jcnlwdElEXG4gICAgPyBxdWVyeXN0cmluZy5zdHJpbmdpZnkoey4uLmV4dHJhLCBsYW5ndWFnZSwgdTogZW5jcnlwdElEfSlcbiAgICA6IHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeSh7Li4uZXh0cmEsIGxhbmd1YWdlfSk7XG59XG5cbmZ1bmN0aW9uIGdldENyZWF0ZUdhbWVVUkxCdXR0b24obGFuZ3VhZ2U6IHN0cmluZywgZW5jcnlwdElEPzogc3RyaW5nKTogT2JqZWN0IHtcbiAgY29uc3QgcXVlcnlQYXJhbXMgPSBfZ2V0VVJMUGFyYW1zKGxhbmd1YWdlLCBlbmNyeXB0SUQpO1xuICByZXR1cm4gQm90LmNyZWF0ZVVSTEJ1dHRvbihcbiAgICBnb3QoJ2J1dHRvbi5jcmVhdGVHYW1lJywgbGFuZ3VhZ2UpLFxuICAgIGAke2NvbmZpZy51cmx9L2dhbWUvY3JlYXRlPyR7cXVlcnlQYXJhbXN9YCxcbiAgICAndGFsbCcsXG4gICAgdHJ1ZSwgLy8gdXNlTWVzc2VuZ2VyRXh0ZW5zaW9uc1xuICApO1xufVxuXG5mdW5jdGlvbiBnZXRKb2luR2FtZVVSTEJ1dHRvbihsYW5ndWFnZTogc3RyaW5nLCBlbmNyeXB0SUQ/OiBzdHJpbmcpOiBPYmplY3Qge1xuICBjb25zdCBxdWVyeVBhcmFtcyA9IF9nZXRVUkxQYXJhbXMobGFuZ3VhZ2UsIGVuY3J5cHRJRCk7XG4gIHJldHVybiBCb3QuY3JlYXRlVVJMQnV0dG9uKFxuICAgIGdvdCgnYnV0dG9uLmpvaW5BUm9vbScsIGxhbmd1YWdlKSxcbiAgICBgJHtjb25maWcudXJsfS9qb2luR2FtZT8ke3F1ZXJ5UGFyYW1zfWAsXG4gICAgJ2NvbXBhY3QnLFxuICAgIHRydWUsIC8vIHVzZU1lc3NlbmdlckV4dGVuc2lvbnNcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0TWVzc2FnZVVSTEJ1dHRvbihcbiAgdGl0bGU6IHN0cmluZyxcbiAgbGFuZ3VhZ2U6IHN0cmluZyxcbiAgcmVjZWl2ZXJJRD86IG51bWJlcixcbiAgZW5jcnlwdElEPzogc3RyaW5nLFxuKTogT2JqZWN0IHtcbiAgY29uc3QgcXVlcnlQYXJhbXNTdHJpbmcgPSBfZ2V0VVJMUGFyYW1zKGxhbmd1YWdlLCBlbmNyeXB0SUQsIHtyZWNlaXZlcklEfSk7XG4gIHJldHVybiBCb3QuY3JlYXRlVVJMQnV0dG9uKFxuICAgIHRpdGxlLFxuICAgIGAke2NvbmZpZy51cmx9L21lc3NhZ2U/JHtxdWVyeVBhcmFtc1N0cmluZ31gLFxuICAgICdmdWxsJyxcbiAgICB0cnVlLCAvLyB1c2VNZXNzZW5nZXJFeHRlbnNpb25zXG4gICk7XG59XG5cbmZ1bmN0aW9uIGdldEJvYXJkVVJMQnV0dG9uKHRpdGxlOiBzdHJpbmcsIHF1ZXJ5UGFyYW1zOiBzdHJpbmcpOiBPYmplY3Qge1xuICByZXR1cm4gQm90LmNyZWF0ZVVSTEJ1dHRvbihcbiAgICB0aXRsZSxcbiAgICBgJHtjb25maWcudXJsfS9zaW11bGF0ZUJvYXJkPyR7cXVlcnlQYXJhbXN9YCxcbiAgICAnZnVsbCcsXG4gICAgdHJ1ZSwgLy8gdXNlTWVzc2VuZ2VyRXh0ZW5zaW9uc1xuICApO1xufVxuXG5mdW5jdGlvbiBnZXRDb3VudFNjb3JlVVJMQnV0dG9uKHRpdGxlOiBzdHJpbmcsIHVzZXI6IFVzZXIsIHF1ZXJ5UGFyYW1zOiBPYmplY3QpOiBPYmplY3Qge1xuICBjb25zdCBlbmNyeXB0SUQgPSBFbmNyeXB0VXRpbHMuZW5jcnlwdCh1c2VyLmdldEZCSUQoKSk7XG4gIGNvbnN0IHF1ZXJ5UGFyYW1zU3RyaW5nID0gX2dldFVSTFBhcmFtcyh1c2VyLmdldExhbmd1YWdlKCksIGVuY3J5cHRJRCwgcXVlcnlQYXJhbXMpO1xuICByZXR1cm4gQm90LmNyZWF0ZVVSTEJ1dHRvbihcbiAgICB0aXRsZSxcbiAgICBgJHtjb25maWcudXJsfS9jb3VudFNjb3JlPyR7cXVlcnlQYXJhbXNTdHJpbmd9YCxcbiAgICAnZnVsbCcsXG4gICAgdHJ1ZSwgLy8gdXNlTWVzc2VuZ2VyRXh0ZW5zaW9uc1xuICApO1xufVxuXG5mdW5jdGlvbiBnZXRTaW11bGF0ZUJvYXJkVVJMQnV0dG9uKGxhbmd1YWdlOiBzdHJpbmcsIGVuY3J5cHRJRD86IHN0cmluZyk6IE9iamVjdCB7XG4gIGNvbnN0IHF1ZXJ5UGFyYW1zID0gX2dldFVSTFBhcmFtcyhsYW5ndWFnZSwgZW5jcnlwdElEKTtcbiAgcmV0dXJuIGdldEJvYXJkVVJMQnV0dG9uKGdvdCgnYnV0dG9uLnNpbXVsYXRlR2FtZScsIGxhbmd1YWdlKSwgcXVlcnlQYXJhbXMpO1xufVxuXG5mdW5jdGlvbiBzZW5kRm9jdXNlZEdhbWVNZXNzYWdlKHVzZXI6IFVzZXIsIGdhbWU6IEdvR2FtZSwgbWVzc2FnZTogc3RyaW5nLCBpc0ZvY3VzZWQ6IGJvb2xlYW4pOiB2b2lkIHtcbiAgY29uc3QgbGFuZ3VhZ2UgPSB1c2VyLmdldExhbmd1YWdlKCk7XG4gIGlmIChpc0ZvY3VzZWQpIHtcbiAgICBCb3Quc2VuZFRleHQoXG4gICAgICB1c2VyLmdldEZCSUQoKSxcbiAgICAgIG1lc3NhZ2UsXG4gICAgKTtcbiAgfSBlbHNlIHtcbiAgICBCb3Quc2VuZEJ1dHRvbnMoXG4gICAgICB1c2VyLmdldEZCSUQoKSxcbiAgICAgIG1lc3NhZ2UgKyAnICcgKyBnb3QoJ2luR2FtZU1lc3NhZ2UubmV3R2FtZU1vdmVBc2tVc2VyVG9Gb2N1cycsIGxhbmd1YWdlKSxcbiAgICAgIFtcbiAgICAgICAgY3JlYXRlUG9zdGJhY2tCdXR0b24oZ290KCdidXR0b24uZm9jdXNPbkdhbWUnLCBsYW5ndWFnZSksIFBvc3RCYWNrVHlwZXMuRk9DVVNfT05fR0FNRSwgW2dhbWUuZ2V0SUQoKV0pLFxuICAgICAgXVxuICAgICk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIFBvc3RCYWNrVHlwZXMsXG4gIHNlbmROb3JtYWxIZWxwTWVudSxcbiAgY3JlYXRlRGVmYXVsdEJ1dHRvbnMsXG4gIGNyZWF0ZVBvc3RiYWNrQnV0dG9uLFxuICBjcmVhdGVRdWlja1JlcGx5QnV0dG9uLFxuICBzZW5kRm9jdXNlZEdhbWVNZXNzYWdlLFxuICBnZXRCb2FyZFVSTEJ1dHRvbixcbiAgZ2V0Q3JlYXRlR2FtZVVSTEJ1dHRvbixcbiAgZ2V0Sm9pbkdhbWVVUkxCdXR0b24sXG4gIGdldFNpbXVsYXRlQm9hcmRVUkxCdXR0b24sXG4gIGdldENvdW50U2NvcmVVUkxCdXR0b24sXG4gIGdldE1lc3NhZ2VVUkxCdXR0b24sXG59O1xuIl19